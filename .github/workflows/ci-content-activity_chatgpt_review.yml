# Leka - iOS Monorepo
# Copyright APF France handicap
# SPDX-License-Identifier: Apache-2.0

name: Content - Activity ChatGPT Review

on:
  pull_request:
    paths:
      - "**/*.activity.yml"

jobs:
  review_yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Review YAML files
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python Tools/Content/activity_chatgpt_review.py --content_type activity

      - name: Post Github comment
        id: post_github_comment
        if: ${{ success() && env.CHATGPT_RESPONSES != ''}}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          hide_and_recreate: true
          hide_classify: "OUTDATED"
          header: content_activity_chatgpt_review
          message: |
            # Activity ChatGPT Review

            ${{ env.CHATGPT_RESPONSES }}

      - name: Post to a Slack channel
        id: post_to_slack
        if: ${{ success() && env.CHATGPT_RESPONSES != ''}}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "C9UGVSTGE"
          slack-message: |
            *New Activity ChatGPT Review:*
            https://github.com/leka/ios-monorepo/pull/${{ env.PR_NUMBER }}#issuecomment-${{ steps.post_github_comment.outputs.created_comment_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
